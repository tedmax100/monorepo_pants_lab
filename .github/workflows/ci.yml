name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # ─────────────────────────────────────────────────────────────────
  # PR：只測試有改動的部分（--changed-since）
  # ─────────────────────────────────────────────────────────────────
  test-changed:
    name: Test Changed Targets (PR)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      # fetch-depth: 0：取得完整 commit 歷史，讓 --changed-since 能算 merge-base
      # 不加 filter: blob:none — Pants 的 changed-files 分析需要讀取檔案 blob，
      # blobless clone 會導致 Pants 計算出 0 個 changed targets（已知相容性問題）
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 官方 action：安裝 Pants + 管理快取（取代手動 pip install 和 cache 設定）
      # 參考：github.com/pantsbuild/actions/tree/main/init-pants
      - uses: pantsbuild/actions/init-pants@v5-scie-pants
        with:
          gha-cache-key: v0
          named-caches-hash: ${{ hashFiles('python-default.lock') }}
          cache-lmdb-store: "true"

      # ── Debug：讓 CI log 直接可見 git 狀態和 Pants targets ──────
      - name: Debug git & pants state
        run: |
          echo "=== HEAD commit ==="
          git log -1 --oneline

          echo "=== origin/${{ github.base_ref }} ==="
          git log -1 --oneline origin/${{ github.base_ref }}

          echo "=== git diff --name-only origin/${{ github.base_ref }}...HEAD ==="
          git diff --name-only origin/${{ github.base_ref }}...HEAD

          echo "=== pants --changed-since list ==="
          pants --changed-since=origin/${{ github.base_ref }} list 2>&1 || true

          echo "=== pants --changed-since --changed-dependents=transitive list ==="
          pants --changed-since=origin/${{ github.base_ref }} --changed-dependents=transitive list 2>&1 || true

      - name: Show affected targets in PR summary
        run: |
          BASE=origin/${{ github.base_ref }}

          echo "## Changed files" >> $GITHUB_STEP_SUMMARY
          git diff --name-only ${BASE}...HEAD | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Affected Pants targets" >> $GITHUB_STEP_SUMMARY
          pants \
            --changed-since=${BASE} \
            --changed-dependents=transitive \
            list 2>/dev/null | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

      - name: Test changed targets
        run: |
          pants \
            --changed-since=origin/${{ github.base_ref }} \
            --changed-dependents=transitive \
            test

      - name: Type check changed targets
        run: |
          pants \
            --changed-since=origin/${{ github.base_ref }} \
            --changed-dependents=transitive \
            check

      # 只打包受影響的 binary（go_binary / pex_binary）
      # Pants 會自動跳過不支援 package 的 target（如 go_package、python_sources）
      - name: Package changed binaries
        run: |
          pants \
            --changed-since=origin/${{ github.base_ref }} \
            --changed-dependents=transitive \
            package

      - name: Upload changed binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries-pr-${{ github.sha }}
          path: dist/
          if-no-files-found: ignore

      - name: Upload Pants log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pants-log-pr
          path: .pants.d/pants.log

  # ─────────────────────────────────────────────────────────────────
  # Push to main：完整測試 + 打包所有 binary
  # ─────────────────────────────────────────────────────────────────
  test-all:
    name: Test All & Package (main)
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      # push to main 不需要 diff，預設 depth=1 即可
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: pantsbuild/actions/init-pants@v5-scie-pants
        with:
          gha-cache-key: v0
          named-caches-hash: ${{ hashFiles('python-default.lock') }}
          cache-lmdb-store: "true"

      - name: Test all targets
        run: |
          pants test '::'

      - name: Type check all
        run: |
          pants check '::'

      # 排除 docker_image：Docker build/push 由 docker-build-deploy job 負責
      - name: Package all binaries
        run: |
          pants package --filter-target-type='-docker_image' '::'

      - name: Upload Go binaries
        uses: actions/upload-artifact@v4
        with:
          name: go-binaries
          path: |
            dist/go.cmd.userapi/bin
            dist/go.cmd.orderapi/bin

      - name: Upload Python PEX
        uses: actions/upload-artifact@v4
        with:
          name: python-pex
          path: dist/**/*.pex

      - name: Upload Pants log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pants-log-main
          path: .pants.d/pants.log

  # ─────────────────────────────────────────────────────────────────
  # Push to main：只 build + push 有異動的 Docker image，更新 k8s manifest
  #
  # 前提：
  #   1. GITHUB_TOKEN 自動有 packages:write 權限（ghcr.io 同一個 org）
  #   2. deploy/overlays/production/kustomization.yaml 已有 images 欄位
  #   3. kustomize 已安裝（用 azure/setup-kubectl / kustomize action）
  # ─────────────────────────────────────────────────────────────────
  docker-build-deploy:
    name: Docker Build & Deploy (main)
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    needs: test-all  # 只有測試通過才繼續

    permissions:
      contents: write   # 寫回更新後的 manifest
      packages: write   # push image 到 ghcr.io

    steps:
      # fetch-depth: 0 讓 --changed-since 能找到前一個 commit 的 merge-base
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: pantsbuild/actions/init-pants@v5-scie-pants
        with:
          gha-cache-key: v0
          named-caches-hash: ${{ hashFiles('python-default.lock') }}
          cache-lmdb-store: "true"

      - name: Install kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 找出這次 push 裡有異動的 docker_image targets。
      # github.event.before = 這次 push 之前的 HEAD SHA，是最可靠的 diff 基準。
      # --changed-dependents=transitive 確保改 lib 也能觸發依賴它的 service 重建。
      - name: Detect changed docker targets
        id: detect
        run: |
          CHANGED=$(pants \
            --changed-since=${{ github.event.before }} \
            --changed-dependents=transitive \
            filter --target-type=docker_image \
          )
          echo "Changed docker targets:"
          echo "$CHANGED"

          # 輸出給後續 steps 使用（multiline output 寫法）
          {
            echo 'targets<<EOF'
            echo "$CHANGED"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      # pants publish = build image + push to registries configured in pants.toml.
      # pants.toml 有 build_args 的預設值（local / latest），
      # 這裡用 --docker-build-arg 覆寫成實際的 owner 和 git SHA。
      # --docker-build-arg 的優先度高於 pants.toml 的 build_args 設定值。
      - name: Build & push Docker images
        if: steps.detect.outputs.targets != ''
        run: |
          TARGETS=$(echo "${{ steps.detect.outputs.targets }}" | tr '\n' ' ')
          pants \
            --docker-build-args="GITHUB_REPOSITORY_OWNER=${{ github.repository_owner }}" \
            --docker-build-args="IMAGE_TAG=${{ github.sha }}" \
            publish $TARGETS

      # pants peek 輸出的 JSON 是平層結構，image repository 在 .repository 欄位
      # （不是 .spec.repository）。
      # 用 kustomize edit set image 精準替換 production overlay 的 tag，
      # 完全不影響其他欄位。
      - name: Update k8s image tags
        if: steps.detect.outputs.targets != ''
        env:
          IMAGE_TAG: ${{ github.sha }}
          OWNER: ${{ github.repository_owner }}
        run: |
          sudo apt-get install -y jq

          TARGETS=$(echo "${{ steps.detect.outputs.targets }}" | tr '\n' ' ')

          # pants peek 的 .repository 是未展開的模板字串（含 {build_args.XXX}），
          # 用 sed 替換成實際值後，再傳給 kustomize。
          pants peek $TARGETS \
            | jq -r '.[].repository' \
            | sed "s|{build_args.GITHUB_REPOSITORY_OWNER}|${OWNER}|g" \
            | while read REPO; do
                echo "→ kustomize set image $REPO:$IMAGE_TAG"
                (cd deploy/overlays/production && kustomize edit set image "$REPO=$REPO:$IMAGE_TAG")
              done

      # 如果 manifest 有異動，commit 回 repo 讓 ArgoCD 偵測到並同步。
      # [skip ci] 防止這個 commit 再次觸發 CI 無限迴圈。
      - name: Commit manifest changes
        if: steps.detect.outputs.targets != ''
        run: |
          git config user.name  "ci-bot"
          git config user.email "ci-bot@users.noreply.github.com"
          git add deploy/
          # 只有真的有 diff 才 commit（避免空 commit 報錯）
          git diff --staged --quiet || \
            git commit -m "chore(deploy): update image tags to ${{ github.sha }} [skip ci]" && \
            git push

      - name: Upload Pants log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pants-log-docker
          path: .pants.d/pants.log
