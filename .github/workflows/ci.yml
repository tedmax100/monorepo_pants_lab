name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # ─────────────────────────────────────────────────────────────────
  # PR：只測試有改動的部分（--changed-since）
  # ─────────────────────────────────────────────────────────────────
  test-changed:
    name: Test Changed Targets (PR)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      # blobless clone：fetch-depth: 0 取得所有 commit 歷史（算 merge-base 用）
      # filter: blob:none 跳過檔案內容（不需要），commit history 通常只有幾 MB
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: blob:none

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 官方 action：安裝 Pants + 管理快取（取代手動 pip install 和 cache 設定）
      # 參考：github.com/pantsbuild/actions/tree/main/init-pants
      - uses: pantsbuild/actions/init-pants@v5-scie-pants
        with:
          gha-cache-key: v0
          named-caches-hash: ${{ hashFiles('python-default.lock') }}
          cache-lmdb-store: "true"

      - name: Show affected targets in PR summary
        run: |
          BASE=origin/${{ github.base_ref }}

          echo "## Changed files" >> $GITHUB_STEP_SUMMARY
          git diff --name-only ${BASE}...HEAD | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Affected Pants targets" >> $GITHUB_STEP_SUMMARY
          pants \
            --changed-since=${BASE} \
            --changed-dependents=transitive \
            list 2>/dev/null | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

      - name: Test changed targets
        run: |
          pants \
            --changed-since=origin/${{ github.base_ref }} \
            --changed-dependents=transitive \
            test

      - name: Type check changed targets
        run: |
          pants \
            --changed-since=origin/${{ github.base_ref }} \
            --changed-dependents=transitive \
            check

      - name: Upload Pants log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pants-log-pr
          path: .pants.d/pants.log

  # ─────────────────────────────────────────────────────────────────
  # Push to main：完整測試 + 打包所有 binary
  # ─────────────────────────────────────────────────────────────────
  test-all:
    name: Test All & Package (main)
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      # push to main 不需要 diff，預設 depth=1 即可
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: pantsbuild/actions/init-pants@v5-scie-pants
        with:
          gha-cache-key: v0
          named-caches-hash: ${{ hashFiles('python-default.lock') }}
          cache-lmdb-store: "true"

      - name: Test all targets
        run: |
          pants test '::'

      - name: Type check all
        run: |
          pants check '::'

      - name: Package all binaries
        run: |
          pants package '::'

      - name: Upload Go binaries
        uses: actions/upload-artifact@v4
        with:
          name: go-binaries
          path: |
            dist/go.cmd.userapi/bin
            dist/go.cmd.orderapi/bin

      - name: Upload Python PEX
        uses: actions/upload-artifact@v4
        with:
          name: python-pex
          path: dist/**/*.pex

      - name: Upload Pants log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pants-log-main
          path: .pants.d/pants.log
